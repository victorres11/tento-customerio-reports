name: Customer.io Weekly Report

on:
  schedule:
    # Runs every Wednesday at 9:15 AM UTC
    # Format: minute hour day month day-of-week (0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday)
    - cron: '15 9 * * 3'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Generate report
        env:
          CUSTOMER_IO_API_KEY: ${{ secrets.CUSTOMER_IO_API_KEY }}
        run: |
          # Generate JSON output (redirect to file but also show progress)
          python weekly_report.py --json 2>&1 | tee report.json.tmp
          # Move temp file to final location (filter out progress messages)
          python3 << 'EOF'
          import json
          import sys
          with open('report.json.tmp', 'r') as f:
              content = f.read()
          # Try to find JSON in the output (might have progress messages before it)
          try:
              # Find the JSON object in the output
              start = content.find('{')
              if start != -1:
                  json_str = content[start:]
                  data = json.loads(json_str)
                  with open('report.json', 'w') as out:
                      json.dump(data, out, indent=2)
              else:
                  # No JSON found, might be an error
                  print("Error: No JSON found in output", file=sys.stderr)
                  sys.exit(1)
          except Exception as e:
              print(f"Error parsing JSON: {e}", file=sys.stderr)
              sys.exit(1)
          EOF
          
          # Generate text output (show progress in logs)
          python weekly_report.py > report.txt 2>&1
      
      - name: Format report for Slack
        id: format-report
        run: |
          python3 << 'EOF'
          import json
          import sys
          from datetime import datetime
          
          try:
              with open('report.json', 'r') as f:
                  data = json.load(f)
              
              # Create Slack Block Kit format
              blocks = []
              
              # Header block
              week_start = data['week_start']
              blocks.append({
                  "type": "header",
                  "text": {
                      "type": "plain_text",
                      "text": f"ðŸ“Š Customer.io Weekly Report"
                  }
              })
              
              # Week info
              blocks.append({
                  "type": "section",
                  "text": {
                      "type": "mrkdwn",
                      "text": f"*Week of {week_start}*\nGenerated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}"
                  }
              })
              
              blocks.append({"type": "divider"})
              
              # Campaigns with data
              campaigns_with_data = data['campaigns_with_data']
              if campaigns_with_data:
                  blocks.append({
                      "type": "section",
                      "text": {
                          "type": "mrkdwn",
                          "text": "*âœ¨ Campaigns with Activity*"
                      }
                  })
                  
                  for campaign_name in sorted(campaigns_with_data.keys()):
                      campaign_data = campaigns_with_data[campaign_name]
                      emails = campaign_data.get('emails', [])
                      sms = campaign_data.get('sms', [])
                      
                      # Calculate totals
                      email_total = sum(e['sent'] for e in emails)
                      sms_total = sum(s['sent'] for s in sms)
                      total_sent = email_total + sms_total
                      
                      # Campaign header
                      blocks.append({
                          "type": "section",
                          "text": {
                              "type": "mrkdwn",
                              "text": f"*{campaign_name}*\n*Total Sent: {total_sent}* (ðŸ“§ {email_total} emails, ðŸ’¬ {sms_total} SMS)"
                          }
                      })
                      
                      # Email details
                      if emails:
                          email_text = "\n".join([f"â€¢ ðŸ“§ {e['name']}: *{e['sent']}* sent" for e in emails])
                          blocks.append({
                              "type": "section",
                              "text": {
                                  "type": "mrkdwn",
                                  "text": email_text
                              }
                          })
                      
                      # SMS details
                      if sms:
                          sms_text = "\n".join([f"â€¢ ðŸ’¬ {s['name']}: *{s['sent']}* sent" for s in sms])
                          blocks.append({
                              "type": "section",
                              "text": {
                                  "type": "mrkdwn",
                                  "text": sms_text
                              }
                          })
                      
                      blocks.append({"type": "divider"})
              
              # Campaigns with no data
              campaigns_without_data = data.get('campaigns_without_data', [])
              if campaigns_without_data:
                  blocks.append({
                      "type": "section",
                      "text": {
                          "type": "mrkdwn",
                          "text": f"*âš ï¸ Campaigns with No Activity ({len(campaigns_without_data)})*"
                      }
                  })
                  
                  # Group into chunks of 10 for readability
                  for i in range(0, len(campaigns_without_data), 10):
                      chunk = sorted(campaigns_without_data)[i:i+10]
                      campaign_list = "\n".join([f"  â€¢ {c}" for c in chunk])
                      blocks.append({
                          "type": "section",
                          "text": {
                              "type": "mrkdwn",
                              "text": campaign_list
                          }
                      })
              
              # Summary footer
              total_campaigns = len(campaigns_with_data) + len(campaigns_without_data)
              blocks.append({"type": "divider"})
              blocks.append({
                  "type": "context",
                  "elements": [{
                      "type": "mrkdwn",
                      "text": f"ðŸ“ˆ Total campaigns: {total_campaigns} | Active: {len(campaigns_with_data)} | Inactive: {len(campaigns_without_data)}"
                  }]
              })
              
              # Save formatted JSON for Slack
              slack_payload = {
                  "blocks": blocks
              }
              
              with open('slack_payload.json', 'w') as f:
                  json.dump(slack_payload, f, indent=2)
              
              # Also save text version for fallback
              report_text = f"Week of {week_start} customer.io reporting\n\n"
              for campaign in sorted(campaigns_with_data.keys()):
                  report_text += f"{campaign}\n"
                  for email in campaigns_with_data[campaign]['emails']:
                      report_text += f"Email {email['name']} - {email['sent']} sent\n"
                  for sms in campaigns_with_data[campaign]['sms']:
                      report_text += f"SMS {sms['name']} - {sms['sent']} sent\n"
                  report_text += "\n"
              if campaigns_without_data:
                  report_text += "Campaigns with no data:\n"
                  for campaign in sorted(campaigns_without_data):
                      report_text += f"{campaign}\n"
              
              with open('formatted_report.txt', 'w') as f:
                  f.write(report_text)
              
          except Exception as e:
              print(f"Error formatting report: {e}", file=sys.stderr)
              import traceback
              traceback.print_exc()
              # Fallback: use the text report
              import shutil
              shutil.copy('report.txt', 'formatted_report.txt')
          EOF
      
      - name: Send to Slack
        if: always()
        run: |
          # Try to send formatted blocks, fallback to text if that fails
          if [ -f slack_payload.json ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST -H 'Content-type: application/json' \
              --data @slack_payload.json \
              ${{ secrets.SLACK_WEBHOOK_URL }})
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "Slack API error (HTTP $HTTP_CODE): $BODY"
              echo "Falling back to text format..."
              # Fallback to simple text message
              REPORT=$(cat formatted_report.txt)
              curl -X POST -H 'Content-type: application/json' \
                --data "{\"text\":\"ðŸ“Š *Customer.io Weekly Report*\n\`\`\`\n$REPORT\n\`\`\`\"}" \
                ${{ secrets.SLACK_WEBHOOK_URL }}
            else
              echo "Successfully sent formatted report to Slack"
            fi
          else
            # Fallback to simple text message
            echo "slack_payload.json not found, using text format"
            REPORT=$(cat formatted_report.txt)
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸ“Š *Customer.io Weekly Report*\n\`\`\`\n$REPORT\n\`\`\`\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi
      
      - name: Commit history file
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add report_history.json
          if ! git diff --cached --quiet; then
            git commit -m "Update report history data"
            git push
          else
            echo "No changes to history file"
          fi

      - name: Create GitHub Issue (Fallback if Slack fails)
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('formatted_report.txt', 'utf8');
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Customer.io Weekly Report - ${new Date().toLocaleDateString()}`,
                body: `\`\`\`\n${report}\n\`\`\``,
                labels: ['report', 'automated']
              });
            } catch (error) {
              console.log('Could not create issue:', error);
            }

